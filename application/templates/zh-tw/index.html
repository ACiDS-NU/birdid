<!DOCTYPE HTML>
<!--
	Spatial by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
-->
<html>
	<head>
		<title>Plover - 鳥類影像辨識系統</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/imgareaselect-default.css') }}" />
		<link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">
		<script type="text/javascript" src="{{ url_for('static', filename='scripts/jquery.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='scripts/jquery.imgareaselect.pack.js') }}"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1296992-2"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-1296992-2');
        </script>
	</head>
	<body class="landing">

		<!-- Header -->
			<header id="header" class="alt">
				<h1><strong><a href="{{ url_for('zh_tw_index') }}">Plover</a></strong></h1>
				<nav id="nav">
					<ul>
						<li><a href="{{ url_for('index') }}">English</a></li>
						<li><a href="{{ url_for('zh_tw_index') }}">首頁</a></li>
						<li><a href="{{ url_for('zh_tw_about') }}">關於</a></li>
						<!-- <li><a href="{{ url_for('how_it_works') }}">How it works</a></li> -->
					</ul>
				</nav>
			</header>

			<a href="#menu" class="navPanelToggle"><span class="fa fa-bars"></span></a>

		<!-- Banner -->
			<section id="banner">
				<h2>Plover</h2>
				<p>為賞鳥新手打造的影像辨識系統！</p>
				<ul class="actions">
					<li><a href="#GetStarted" class="button special big">現在就來試試看</a></li>
				</ul>
			</section>

			<!-- One -->
				<section id="GetStarted" class="wrapper style1" style="padding: 3em 0em 0.5em 0em;">
					<div class="container 75%">
						<div class="row 200%">
							<div class="6u 12u$(medium)">
								<header class="major">
									<h2>三步驟認鳥</h2>
									<p>上傳、裁切、辨識。<br/>超簡單，新手也能三秒上手！</p>
								</header>
							</div>
							<div class="6u$ 12u$(medium)">
								<p>我們使用卷積神經網路 (Convolutional Neural Network)，以照片辨識美國常見的 400 種鳥類，讓您不論是新手，或是對美國鳥類不熟悉，都能快速認鳥！</p>
							</div>
						</div>
					</div>
				</section>

			<!-- Two -->
            	<section id="upload" class="wrapper style1 special" style="padding: 1.5em 0em 0.5em 0em;">
					<div class="container">
						<header class="major" style="margin-bottom: 0.5em">
							<h2>首先，上傳照片</h2>
							<p style="color: #333;">接著在照片上拖曳，將想辨認的鳥盡量緊密地框起來</p>
						</header>
						<p style="color: #777;">手機用戶如果覺得很難用，請讓我們知道！ XD</p>
                    	
						<input type="file" id="file" name="file" align="center" />
                    	<form method=post enctype=multipart/form-data id="bird_info">
                    			
							<br/>
							<img id="bird_image" width="60%" align="center" style="margin-top: 0.5em" />
							<br/>
							<input type="hidden" id="x1" name="x1" value="" />
							<input type="hidden" id="y1" name="y1" value="" />
							<input type="hidden" id="x2" name="x2" value="" />
							<input type="hidden" id="y2" name="y2" value="" />
							<input type="hidden" id="w" name="w" value="" />
							<input type="hidden" id="h" name="h" value="" />
							<input type="hidden" id="lat" name="lat" value="" />
							<input type="hidden" id="lon" name="lon" value="" />
							<input type="hidden" id="loc" name="location" value="" />
							<br/>
							<h4>下列資訊可留白，但輸入這些資訊可以幫助我們更精確地進行辨識。</h4>
							拍攝日期（年份不重要，我們只用日期來查詢鳥類出現的機率）：
							<input type="date" id="date" name="date" min="2019-01-01" max="2019-12-31"> <br/><br/>
    				      	<input type="text" name="addr" placeholder="您在哪裡拍攝這張照片的？（請用英文）" value="" id="addr" size="10" style="width: 50%; margin: auto; display: inline;" />
 				      		<button type="button" id="search_addr" style="display: inline; font-family: inherit;" onclick="addr_search();">查詢地址</button>
 				      		<div id="results"></div>
				      		<div id="selected_addr"></div>
							<br/>
							<input class="button special big" id="Upload" value="上傳照片" onclick="crop_resize()">
				      		<!--<input class="button special big" id="Upload" type=submit value=Upload onsubmit="crop_resize()">-->
				      		<input type="hidden" id="croppedImg" name="croppedImg" value=""/>

                     </form>

					</div>
				</section>
				

		<!-- Footer -->
			<footer id="footer">
				<div class="container">
					<ul class="icons">
						<li><a href="https://github.com/darrenjhsu/birdid" class="icon fa-github" target="_blank"></a></li>
						<li><a href="https://www.linkedin.com/in/darren-hsu-76bbbb8b/" class="icon fa-linkedin" target="_blank"></a></li>
						<li><a href="https://www.flickr.com/photos/darren8221/" class="icon fa-flickr" target="_blank"></a></li>
					</ul>
					<ul class="copyright">
						<li>&copy; The Piping Plover</li>
						<li>版面設計：<a href="http://templated.co" target="_blank">TEMPLATED</a></li>
						<li>聯絡我們：contact@plover-birdid.com</li>
					</ul>
				</div>
			</footer>

		<!-- Scripts -->
			<!-- <script src="static/js/jquery.min.js"></script> -->
			<script src="{{ url_for('static', filename='js/skel.min.js') }}"></script>
			<script src="{{ url_for('static', filename='js/util.js') }}"></script>
			<script src="{{ url_for('static', filename='js/main.js') }}"></script>
			<script type="text/javascript">
				document.getElementById("file").onchange = function () {
					var reader = new FileReader();

					reader.onload = function (e) {
						// get loaded data and render thumbnail.
						var myImg = document.getElementById("bird_image");
						myImg.src = e.target.result;
						myImg.onload = function() {
						//document.getElementById("bird_image").src = e.target.result;
							var myImg = document.getElementById("bird_image");
							console.log(myImg.width, myImg.height);
							$('input[name="x1"]').val(0);
							$('input[name="y1"]').val(0);
							$('input[name="x2"]').val(myImg.width);
							$('input[name="y2"]').val(myImg.height);
							$('input[name="w"]').val(myImg.width);
							$('input[name="h"]').val(myImg.height);
						};
					};

					// read the image file as a data URL.
					reader.readAsDataURL(this.files[0]);
				};
				$(function () {
					$('#bird_image').imgAreaSelect({ 
						// aspectRatio: '1:1', 
						handles: true,
						onSelectEnd: function (img, selection) {
							$('input[name="x1"]').val(selection.x1);
							$('input[name="y1"]').val(selection.y1);
							$('input[name="x2"]').val(selection.x2);
							$('input[name="y2"]').val(selection.y2);
							$('input[name="w"]').val(img.width);
							$('input[name="h"]').val(img.height);
						}
					});
				});
			</script>
			<script type="text/javascript">
				$(function () {
				   	document.getElementById("bird_image").addEventListener("touchstart", touchHandler, true);
			    	document.getElementById("bird_image").addEventListener("touchmove", touchHandler, true);
			    	document.getElementById("bird_image").addEventListener("touchend", touchHandler, true);
			    	document.getElementById("bird_image").addEventListener("touchcancel", touchHandler, true);
			    	// document.getElementById("bird_image").myprefixNoScroll=1;
				})
				function touchHandler(event)
				{
					var touches = event.changedTouches,
					first = touches[0],
					type = "";
					switch(event.type)
					{
						case "touchstart": type = "mousedown"; break;
						case "touchmove":  type = "mousemove"; break;        
						case "touchend":   type = "mouseup";   break;
						default:           return;
					}

				    // initMouseEvent(type, canBubble, cancelable, view, clickCount, 
				    //                screenX, screenY, clientX, clientY, ctrlKey, 
				    //                altKey, shiftKey, metaKey, button, relatedTarget);

				    var simulatedEvent = document.createEvent("MouseEvent");
				    simulatedEvent.initMouseEvent(type, true, true, window, 1, 
				    	first.screenX, first.screenY, 
				    	first.clientX, first.clientY, false, 
				    	false, false, false, 0/*left*/, null);

				    first.target.dispatchEvent(simulatedEvent);
				    // if (first.target.myPrefixNoScrolling) event.preventDefault();
				    event.preventDefault();
				}

			</script>

			<script>
				function crop_resize() {
					console.log("Hello World!!");
					var myImg = document.getElementById("bird_image");
			        var realWidth = myImg.naturalWidth;
        			var realHeight = myImg.naturalHeight;
        			var selection_x1 = document.getElementById("x1").value;
        			var selection_y1 = document.getElementById("y1").value;
        			var selection_x2 = document.getElementById("x2").value;
        			var selection_y2 = document.getElementById("y2").value;
        			var img_w = document.getElementById("w").value;
        			var img_h = document.getElementById("h").value;
        			console.log("Original width=" + realWidth + ", " + "Original height=" + realHeight);
        			console.log(selection_x1,selection_y1,selection_x2,selection_y2,img_w,img_h);
        			var scaling = realWidth / img_w;
        			console.log(scaling)
        			var canvas = document.createElement('canvas');
			        canvas.width = 224;
        			canvas.height = 224;
        			canvas.style.cssText = 'display:none;';
        			var ctx = canvas.getContext("2d");

        			if ((selection_x2 - selection_x1) > (selection_y2 - selection_y1)) {
        				//if ((selection_x2 - selection_x1) * scaling > 224) {
        					ctx.drawImage(myImg, selection_x1 * scaling, selection_y1 * scaling,
        						(selection_x2 - selection_x1) * scaling, (selection_y2 - selection_y1) * scaling,
        						0, 112 - (selection_y2 - selection_y1) / (selection_x2 - selection_x1) * 224 / 2,
        						224, (selection_y2 - selection_y1) / (selection_x2 - selection_x1) * 224);
        				//}
        			} else {
        				//if ((selection_y2 - selection_y1) * scaling > 224) {
							ctx.drawImage(myImg, selection_x1 * scaling, selection_y1 * scaling,
        						(selection_x2 - selection_x1) * scaling,(selection_y2 - selection_y1) * scaling,
        						112 - (selection_x2 - selection_x1) / (selection_y2 - selection_y1) * 224 / 2 , 0,
        						(selection_x2 - selection_x1) / (selection_y2 - selection_y1) * 224, 224);
        				//}
        			}
        			document.body.appendChild(canvas); 
        			var dataURL = canvas.toDataURL("image/jpeg", 1.0);
        			document.getElementById("croppedImg").value = dataURL;
        			console.log(dataURL);
        			document.getElementById("bird_info").submit();
			        
				}

			</script>

			<script>
				// Thanks to this https://derickrethans.nl/leaflet-and-nominatim.html
				function addr_search() {
					var inp = document.getElementById("addr");

					$.getJSON('https://nominatim.openstreetmap.org/search?format=json&limit=5&countrycodes=us&accept-language=en-US&addressdetails=0&q=' + inp.value, function(data) {
						var items = [];

						$.each(data, function(key, val) {
							items.push(
								"<span><a href='#' onclick='chooseAddr(" +
								val.lat + ", " + val.lon + ", encodeURI(\"" + val.display_name.replace(/'/g, "%27") + "\"));return false;'>" + val.display_name +
								'</a></span><br/>'
								);
						});
						$('#results').empty();
						if (items.length != 0) {
							$('<span>', { html: "<br/>選擇您的拍照位置：" }).appendTo('#results');
							$('<p>', {
								'class': 'my-new-list',
								html: items.join('')
							}).appendTo('#results');
						} else {
							$('<p>', { html: "並未找到符合條件的地址，請再試一次。" }).appendTo('#results');
						}
					});
				}
				function chooseAddr(lat, lng, name) {
					$('input[name="lat"]').val(lat);
					$('input[name="lon"]').val(lng);
					$('input[name="location"]').val(decodeURI(name));
					$('#selected_addr').empty();
					$('<span>', { html: "您選擇的地址是：" + decodeURI(name) + " (" + lat + ", " + lng + ")"}).appendTo('#selected_addr');
  				}
			</script>
			<script type="text/javascript">
				$(document).keypress(
  					function(event){
    				if (event.which == '13') {
						event.preventDefault();
					}
				});
				var input2 = document.getElementById("Upload");
				input2.addEventListener("click", function(event) {
					if (event.keyCode === 13) {
						event.preventDefault();
					}
				});
			</script>	
			<script>
				var input = document.getElementById("addr");
				input.addEventListener("keyup", function(event) {
					if (event.keyCode === 13) {
						event.preventDefault();
						document.getElementById("search_addr").click();
					}
				});
			</script>

	</body>
</html>
